<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>遊戲作業</title>
</head>

<body>
    <!--Nav開始 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">遊戲作業 &nbsp;(學生:蕭維均&nbsp;學號:1100336)</a>
        </div>
    </nav>
    <!--Nav結束 -->

    <br>
    <!--Canvas開始 -->
    <canvas id="MainCanvas" width="500px" height="500px"></canvas>
    <!--Canvas結束 -->
</body>

<style>
    canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
    }
</style>

<script src="http://code.jquery.com/jquery-1.6.4.min.js" type="text/javascript"></script>

<script>

    //基礎canvas物件
    var canvas = document.getElementById("MainCanvas");
    var ctx = canvas.getContext("2d");
    //裝載敵人物件的陣列
    var enemyArray = Array()
    //敵機出現排程器
    var enemyScheduler
    //背景物件
    var background
    //自機飛行器物件
    var selfAircraft

    //背景
    function BackgroundObj() {
        this.update = function () {
            var imageObj = new Image();
            imageObj.src = "./GameAsset/SBS - Seamless Space Backgrounds - Large 1024x1024/Large 1024x1024/Blue Nebula/Blue Nebula 1 - 1024x1024.png";
            ctx.drawImage(imageObj, 0, 0, 500, 500)
        }
    }

    //自機
    function SelfAircraft() {
        this.positionX = 250
        this.positionY = 450
        this.targetX = 0
        this.targetY = 0
        this.hitBoxX = 30
        this.hitBoxY = 30

        //鍵盤偵聽與自機移動
        this.listenKeyForMove = function () {
            document.onkeydown = function (e) {
                if (e.keyCode == 37) {
                    if (selfAircraft.positionX < 10) return
                    selfAircraft.positionX -= 5
                }
                else if (e.keyCode == 39) {
                    if (selfAircraft.positionX > 460) return
                    selfAircraft.positionX += 5
                }
            }
        }

        //繪製自機
        this.draw = function () {
            var imageObj = new Image();
            imageObj.src = "./GameAsset/spaceshooter/PNG/playerShip3_blue.png";
            ctx.drawImage(imageObj, this.positionX, this.positionY, 30, 30)
        }
        //繪製自機
        this.update = function () {
            this.draw()
        }
    }

    //敵人1(隨機移動發射飛彈的敵人)
    function enemy1Aircraft() {
        this.ImageSrc = "./GameAsset/spaceshooter/PNG/Enemies/enemyRed1.png";
        this.enemyID = Date.now().toString(36) + Math.random().toString(36).substr(2);
        this.positionX = Math.floor(Math.random() * 470)
        this.positionY = -10
        this.targetX = 0
        this.targetY = 0
        this.hitBoxX = 30
        this.hitBoxY = 30

        //繪製敵機
        this.draw = function () {
            var imageObj = new Image();
            imageObj.src = this.ImageSrc;
            ctx.drawImage(imageObj, this.positionX, this.positionY, this.hitBoxX, this.hitBoxY)
        }

        //設置下一個移動點X
        this.setNextMoveX = function () {
            return Math.floor(Math.random() * 500)
        }

        //設置下一個移動點Y
        this.setNextMoveY = function () {
            return Math.floor(Math.random() * 300)
        }

        //自動移動
        this.autoMove = function () {
            //X軸隨機移動
            if (this.positionX - this.targetX < 1 && this.positionX - this.targetX > -1) {
                this.targetX = this.setNextMoveX()
            } else if (this.positionX - this.targetX > 0) {
                this.positionX -= 1
            } else if (this.positionX - this.targetX < 0) {
                this.positionX += 1
            }
            //Y軸隨機移動
            if (this.positionY - this.targetY < 1 && this.positionY - this.targetY > -1) {
                this.targetY = this.setNextMoveY()
            } else if (this.positionY - this.targetY > 0) {
                this.positionY -= 1
            } else if (this.positionY - this.targetY < 0) {
                this.positionY += 1
            }
        }

        //隨機射出子彈
        this.shoot = function () {
            if (Math.floor(Math.random() * 300) == 1) {
                enemyArray.push(new EnemyBullet1(this.positionX + (this.hitBoxX / 2), this.positionY + this.hitBoxY))
            }
        }

        //更新敵機
        this.update = function () {
            this.shoot()
            this.autoMove()
            this.draw()
        }

        //檢查自身在敵人陣列中的位置
        this.checkSelfIndexInEnemyArray = function () {
            for (i = 0; i < enemyArray.length; i++) {
                enemy = enemyArray[i]
                if (enemy.enemyID == this.enemyID) return i
            }
        }

        //刪去自身
        this.deleteSelfInArray = function () {
            enemyArray.splice(this.checkSelfIndexInEnemyArray(), 1)
        }
    }

    //敵人2
    function enemy2Aircraft() {
        enemy1Aircraft.apply(this);//繼承所有敵機1的屬性。
        this.ImageSrc = "./GameAsset/spaceshooter/PNG/Enemies/enemyRed2.png";
    }

    //敵人3
    function enemy3Aircraft() {
        enemy1Aircraft.apply(this);//繼承所有敵機1的屬性。
        this.ImageSrc = "./GameAsset/kenney_spaceshooterextension/PNG/Sprites X2/Station/spaceStation_017.png";
        this.hitBoxX = 100
        this.hitBoxY = 100
        this.targetX = 0
        this.targetY = 20

        //設置下一個移動點X
        this.setNextMoveX = function () {
            if (this.positionX >= 500-this.hitBoxX) {
                return 0
            } else if (this.positionX <= 0) {
                return 500-this.hitBoxX
            }else{
                return 500-this.hitBoxX
            }
        }

        //設置下一個移動點Y
        this.setNextMoveY = function () {
            return this.targetY
        }

    }

    //敵機子彈1，直線前進的雷射
    function EnemyBullet1(x, y) {
        this.positionX = x
        this.positionY = y
        this.hitBoxX = 5
        this.hitBoxY = 20

        //繪製子彈
        this.draw = function () {
            var imageObj = new Image();
            imageObj.src = "./GameAsset/spaceshooter/PNG/Lasers/laserRed15.png";
            ctx.drawImage(imageObj, this.positionX, this.positionY, this.hitBoxX, this.hitBoxY)
        }

        //自動移動
        this.autoMove = function () {
            this.positionY += 1
        }

        //更新子彈
        this.update = function () {
            this.autoMove()
            this.draw()
        }
    }

    //敵機出現排程
    function EnemyScheduler() {
        this.startTime = new Date();
        this.gameTime = 0
        //敵人排程
        this.schedule = [
            { "Second": 1, "Enemy": 1, "Number": 5 },//第一秒，一號敵人，兩個
            { "Second": 3, "Enemy": 2, "Number": 5 },
            { "Second": 3, "Enemy": 3, "Number": 2 },
        ]

        //投放敵人
        this.createEnemy = function (EnemyNumber) {
            if (EnemyNumber == 1) {
                enemyArray.push(new enemy1Aircraft())
            } else if (EnemyNumber == 2) {
                enemyArray.push(new enemy2Aircraft())
            } else if (EnemyNumber == 3) {
                enemyArray.push(new enemy3Aircraft())
            }
        }

        //如果時間到將敵人放入
        this.action = function () {
            for (i = 0; i < this.schedule.length; i++) {
                var oneAction = this.schedule[0]
                if (oneAction.Second <= this.gameTime) {
                    for (i = 0; i < oneAction.Number; i++) {
                        this.createEnemy(oneAction.Enemy)
                    }
                    this.schedule.shift()
                }
            }
        }

        this.update = function () {
            this.action()
            var now = new Date()
            this.gameTime = parseInt((now - this.startTime) / 1000)
        }

    }

    //更新所有物件
    function updateAll() {
        //繪製背景
        background.update()
        //繪製自機
        selfAircraft.update()
        //更新敵人排程器
        enemyScheduler.update()
        //更新所有敵機
        for (i = 0; i < enemyArray.length; i++) {
            enemyArray[i].update()
        }
    }

    //初始化所有物件
    function init() {
        //啟動背景
        background = new BackgroundObj()
        //啟動飛行器與鍵盤偵聽
        selfAircraft = new SelfAircraft()
        selfAircraft.listenKeyForMove()
        //設置敵人排程器
        enemyScheduler = new EnemyScheduler()
    }

    //主函數
    function mainLoop() {
        updateAll()
    }

    //初始化各個物件
    init()
    //啟動主函數
    setInterval(mainLoop, 10)
</script>